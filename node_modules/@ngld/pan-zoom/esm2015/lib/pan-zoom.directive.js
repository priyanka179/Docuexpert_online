import { Directive, ElementRef, HostListener, Output, EventEmitter, Input, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { normalizePassiveListenerOptions } from '@angular/cdk/platform';
const activeCapturingEventOptions = normalizePassiveListenerOptions({
    passive: false,
    capture: true,
});
function isTouch(event) {
    return !!event.targetTouches;
}
function getCoordinate(event, clientRect) {
    if (isTouch(event)) {
        return {
            x: event.targetTouches[0].clientX,
            y: event.targetTouches[1].clientY,
        };
    }
    return {
        x: event.clientX - clientRect.left,
        y: event.clientY - clientRect.top,
    };
}
export class PanZoomDirective {
    constructor(el, 
    // Avoid ngcc error:
    // https://github.com/angular/components/blob/2b1d84e2bc1d7295e53a753211e99a0e73110b45/src/cdk/drag-drop/drag-drop-registry.ts#L64
    $document) {
        this.el = el;
        this.pointerOrigin = { x: 0, y: 0 };
        this.isPointerDown = false;
        this.previousViewBox = {
            minX: 0, minY: 0, width: 500, height: 500,
        };
        this.excludeChildrenElements = [];
        this.viewBox = {
            minX: 0, minY: 0, width: 500, height: 500,
        };
        this.scaleFactor = 1.3;
        this.viewBoxChanged = new EventEmitter();
        this.pointerDownListener = (event) => {
            if (!this.el.nativeElement.contains(event.target)) {
                return;
            }
            if (this.excludeChildrenElements.find(c => c.checkExclusion(event.target))) {
                this.isPointerDown = false;
                return;
            }
            this.isPointerDown = true;
            this.pointerOrigin = getCoordinate(event, { top: 0, left: 0 });
            this.previousViewBox = Object.assign({}, this.viewBox);
            this.boundingSize = undefined;
        };
        this.pointerUpListener = (event) => {
            this.isPointerDown = false;
            this.previousViewBox = undefined;
        };
        this.pointerMoveListener = (event) => {
            if (!this.isPointerDown) {
                return;
            }
            if (!this.boundingSize) {
                this.boundingSize = this.el.nativeElement.getBoundingClientRect();
            }
            // Prevent user to do a selection on the page
            event.preventDefault();
            // Get the current pointer position
            const pointerPosition = getCoordinate(event, { top: 0, left: 0 });
            const ratio = this.previousViewBox.width / this.boundingSize.width;
            const newViewBox = {
                minX: this.previousViewBox.minX - ((pointerPosition.x - this.pointerOrigin.x) * ratio),
                minY: this.previousViewBox.minY - ((pointerPosition.y - this.pointerOrigin.y) * ratio)
            };
            this.viewBoxChanged.emit(Object.assign(Object.assign({}, this.viewBox), newViewBox));
        };
        this.document = $document;
    }
    ngOnInit() {
        this.document.addEventListener('touchstart', this.pointerDownListener, activeCapturingEventOptions);
        this.document.addEventListener('mousedown', this.pointerDownListener, activeCapturingEventOptions);
        this.document.addEventListener('pointerdown', this.pointerDownListener, activeCapturingEventOptions);
        this.document.addEventListener('touchend', this.pointerUpListener, activeCapturingEventOptions);
        this.document.addEventListener('mouseup', this.pointerUpListener, activeCapturingEventOptions);
        this.document.addEventListener('pointerup', this.pointerUpListener, activeCapturingEventOptions);
        this.document.addEventListener('touchmove', this.pointerMoveListener, activeCapturingEventOptions);
        this.document.addEventListener('mousemove', this.pointerMoveListener, activeCapturingEventOptions);
        this.document.addEventListener('pointermove', this.pointerMoveListener, activeCapturingEventOptions);
    }
    ngOnDestroy() {
        this.document.removeEventListener('touchstart', this.pointerDownListener, activeCapturingEventOptions);
        this.document.removeEventListener('mousedown', this.pointerDownListener, activeCapturingEventOptions);
        this.document.removeEventListener('pointerdown', this.pointerDownListener, activeCapturingEventOptions);
        this.document.removeEventListener('touchend', this.pointerUpListener, activeCapturingEventOptions);
        this.document.removeEventListener('mouseup', this.pointerUpListener, activeCapturingEventOptions);
        this.document.removeEventListener('pointerup', this.pointerUpListener, activeCapturingEventOptions);
        this.document.removeEventListener('touchmove', this.pointerMoveListener, activeCapturingEventOptions);
        this.document.removeEventListener('mousemove', this.pointerMoveListener, activeCapturingEventOptions);
        this.document.removeEventListener('pointermove', this.pointerMoveListener, activeCapturingEventOptions);
    }
    /**
     * excludeChild
     */
    excludeChild(component) {
        this.excludeChildrenElements.push(component);
    }
    /**
     * onExcludeDestroyed
     */
    onExcludeDestroyed(component) {
        this.excludeChildrenElements = this.excludeChildrenElements
            .filter(c => c !== component);
    }
    onZoom(e) {
        e.preventDefault();
        const position = getCoordinate(e, this.el.nativeElement.getBoundingClientRect());
        const scale = Math.pow(this.scaleFactor, e.deltaY < 0 ? 1 : -1);
        const sx = position.x / this.el.nativeElement.clientWidth;
        const sy = position.y / this.el.nativeElement.clientHeight;
        const x = this.viewBox.minX + this.viewBox.width * sx;
        const y = this.viewBox.minY + this.viewBox.height * sy;
        this.viewBoxChanged.emit({
            minX: x + scale * (this.viewBox.minX - x),
            minY: y + scale * (this.viewBox.minY - y),
            width: this.viewBox.width * scale,
            height: this.viewBox.height * scale,
        });
    }
}
PanZoomDirective.decorators = [
    { type: Directive, args: [{
                selector: '[ngldPanZoom]'
            },] }
];
PanZoomDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
PanZoomDirective.propDecorators = {
    viewBox: [{ type: Input }],
    scaleFactor: [{ type: Input }],
    viewBoxChanged: [{ type: Output }],
    onZoom: [{ type: HostListener, args: ['wheel', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuLXpvb20uZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9wYW4tem9vbS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQXFCLFlBQVksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUgsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBR3hFLE1BQU0sMkJBQTJCLEdBQUcsK0JBQStCLENBQUM7SUFDbEUsT0FBTyxFQUFFLEtBQUs7SUFDZCxPQUFPLEVBQUUsSUFBSTtDQUNkLENBQUMsQ0FBQztBQUVILFNBQVMsT0FBTyxDQUFDLEtBQThCO0lBQzdDLE9BQU8sQ0FBQyxDQUFFLEtBQW9CLENBQUMsYUFBYSxDQUFDO0FBQy9DLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FDcEIsS0FBOEIsRUFDOUIsVUFBeUM7SUFDekMsSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDbEIsT0FBTztZQUNMLENBQUMsRUFBRSxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU87WUFDakMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTztTQUNsQyxDQUFDO0tBQ0g7SUFDRCxPQUFPO1FBQ0wsQ0FBQyxFQUFFLEtBQUssQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLElBQUk7UUFDbEMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLEdBQUc7S0FDbEMsQ0FBQztBQUNKLENBQUM7QUFLRCxNQUFNLE9BQU8sZ0JBQWdCO0lBcUIzQixZQUNVLEVBQTZCO0lBQ3JDLG9CQUFvQjtJQUNwQixr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QUUsQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUN6QyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUN6QyxLQUFLLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsS0FBSztZQUNqQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsS0FBSztTQUNwQyxDQUFDLENBQUM7SUFDTCxDQUFDOzs7WUFySUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxlQUFlO2FBQzFCOzs7WUEvQm1CLFVBQVU7NENBeUR6QixNQUFNLFNBQUMsUUFBUTs7O3NCQWRqQixLQUFLOzBCQUlMLEtBQUs7NkJBRUwsTUFBTTtxQkFpR04sWUFBWSxTQUFDLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgT25Jbml0LCBPbkRlc3Ryb3ksIEhvc3RMaXN0ZW5lciwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIElucHV0LCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IG5vcm1hbGl6ZVBhc3NpdmVMaXN0ZW5lck9wdGlvbnMgfSBmcm9tICdAYW5ndWxhci9jZGsvcGxhdGZvcm0nO1xuaW1wb3J0IHsgUGFuWm9vbUV4Y2x1ZGVEaXJlY3RpdmUgfSBmcm9tICcuL3Bhbi16b29tLWV4Y2x1ZGUuZGlyZWN0aXZlJztcblxuY29uc3QgYWN0aXZlQ2FwdHVyaW5nRXZlbnRPcHRpb25zID0gbm9ybWFsaXplUGFzc2l2ZUxpc3RlbmVyT3B0aW9ucyh7XG4gIHBhc3NpdmU6IGZhbHNlLFxuICBjYXB0dXJlOiB0cnVlLFxufSk7XG5cbmZ1bmN0aW9uIGlzVG91Y2goZXZlbnQ6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KTogZXZlbnQgaXMgVG91Y2hFdmVudCB7XG4gIHJldHVybiAhIShldmVudCBhcyBUb3VjaEV2ZW50KS50YXJnZXRUb3VjaGVzO1xufVxuXG5mdW5jdGlvbiBnZXRDb29yZGluYXRlKFxuICBldmVudDogTW91c2VFdmVudCB8IFRvdWNoRXZlbnQsXG4gIGNsaWVudFJlY3Q6IHsgbGVmdDogbnVtYmVyLCB0b3A6IG51bWJlciB9KTogeyB4OiBudW1iZXIsIHk6IG51bWJlciB9IHtcbiAgaWYgKGlzVG91Y2goZXZlbnQpKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IGV2ZW50LnRhcmdldFRvdWNoZXNbMF0uY2xpZW50WCxcbiAgICAgIHk6IGV2ZW50LnRhcmdldFRvdWNoZXNbMV0uY2xpZW50WSxcbiAgICB9O1xuICB9XG4gIHJldHVybiB7XG4gICAgeDogZXZlbnQuY2xpZW50WCAtIGNsaWVudFJlY3QubGVmdCxcbiAgICB5OiBldmVudC5jbGllbnRZIC0gY2xpZW50UmVjdC50b3AsXG4gIH07XG59XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tuZ2xkUGFuWm9vbV0nXG59KVxuZXhwb3J0IGNsYXNzIFBhblpvb21EaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG5cbiAgcHJpdmF0ZSBwb2ludGVyT3JpZ2luID0geyB4OiAwLCB5OiAwIH07XG4gIHByaXZhdGUgaXNQb2ludGVyRG93biA9IGZhbHNlO1xuICBwcml2YXRlIGJvdW5kaW5nU2l6ZT86IHsgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIgfTtcbiAgcHJpdmF0ZSBwcmV2aW91c1ZpZXdCb3ggPz0ge1xuICAgIG1pblg6IDAsIG1pblk6IDAsIHdpZHRoOiA1MDAsIGhlaWdodDogNTAwLFxuICB9O1xuICBwcml2YXRlIGV4Y2x1ZGVDaGlsZHJlbkVsZW1lbnRzOiBQYW5ab29tRXhjbHVkZURpcmVjdGl2ZVtdID0gW107XG4gIHByaXZhdGUgZG9jdW1lbnQ6IERvY3VtZW50O1xuXG4gIEBJbnB1dCgpIHZpZXdCb3ggPSB7XG4gICAgbWluWDogMCwgbWluWTogMCwgd2lkdGg6IDUwMCwgaGVpZ2h0OiA1MDAsXG4gIH07XG5cbiAgQElucHV0KCkgc2NhbGVGYWN0b3IgPSAxLjM7XG5cbiAgQE91dHB1dCgpIHZpZXdCb3hDaGFuZ2VkID0gbmV3IEV2ZW50RW1pdHRlcjx7XG4gICAgbWluWDogbnVtYmVyLCBtaW5ZOiBudW1iZXIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLFxuICB9PigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZWw6IEVsZW1lbnRSZWY8U1ZHU1ZHRWxlbWVudD4sXG4gICAgLy8gQXZvaWQgbmdjYyBlcnJvcjpcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9jb21wb25lbnRzL2Jsb2IvMmIxZDg0ZTJiYzFkNzI5NWU1M2E3NTMyMTFlOTlhMGU3MzExMGI0NS9zcmMvY2RrL2RyYWctZHJvcC9kcmFnLWRyb3AtcmVnaXN0cnkudHMjTDY0XG4gICAgQEluamVjdChET0NVTUVOVCkgJGRvY3VtZW50OiBhbnksXG4gICkge1xuICAgIHRoaXMuZG9jdW1lbnQgPSAkZG9jdW1lbnQ7XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCB0aGlzLnBvaW50ZXJEb3duTGlzdGVuZXIsIGFjdGl2ZUNhcHR1cmluZ0V2ZW50T3B0aW9ucyk7XG4gICAgdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLnBvaW50ZXJEb3duTGlzdGVuZXIsIGFjdGl2ZUNhcHR1cmluZ0V2ZW50T3B0aW9ucyk7XG4gICAgdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVyZG93bicsIHRoaXMucG9pbnRlckRvd25MaXN0ZW5lciwgYWN0aXZlQ2FwdHVyaW5nRXZlbnRPcHRpb25zKTtcblxuICAgIHRoaXMuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLnBvaW50ZXJVcExpc3RlbmVyLCBhY3RpdmVDYXB0dXJpbmdFdmVudE9wdGlvbnMpO1xuICAgIHRoaXMuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMucG9pbnRlclVwTGlzdGVuZXIsIGFjdGl2ZUNhcHR1cmluZ0V2ZW50T3B0aW9ucyk7XG4gICAgdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVydXAnLCB0aGlzLnBvaW50ZXJVcExpc3RlbmVyLCBhY3RpdmVDYXB0dXJpbmdFdmVudE9wdGlvbnMpO1xuXG4gICAgdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLnBvaW50ZXJNb3ZlTGlzdGVuZXIsIGFjdGl2ZUNhcHR1cmluZ0V2ZW50T3B0aW9ucyk7XG4gICAgdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLnBvaW50ZXJNb3ZlTGlzdGVuZXIsIGFjdGl2ZUNhcHR1cmluZ0V2ZW50T3B0aW9ucyk7XG4gICAgdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVybW92ZScsIHRoaXMucG9pbnRlck1vdmVMaXN0ZW5lciwgYWN0aXZlQ2FwdHVyaW5nRXZlbnRPcHRpb25zKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHRoaXMucG9pbnRlckRvd25MaXN0ZW5lciwgYWN0aXZlQ2FwdHVyaW5nRXZlbnRPcHRpb25zKTtcbiAgICB0aGlzLmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMucG9pbnRlckRvd25MaXN0ZW5lciwgYWN0aXZlQ2FwdHVyaW5nRXZlbnRPcHRpb25zKTtcbiAgICB0aGlzLmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgdGhpcy5wb2ludGVyRG93bkxpc3RlbmVyLCBhY3RpdmVDYXB0dXJpbmdFdmVudE9wdGlvbnMpO1xuXG4gICAgdGhpcy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRoaXMucG9pbnRlclVwTGlzdGVuZXIsIGFjdGl2ZUNhcHR1cmluZ0V2ZW50T3B0aW9ucyk7XG4gICAgdGhpcy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5wb2ludGVyVXBMaXN0ZW5lciwgYWN0aXZlQ2FwdHVyaW5nRXZlbnRPcHRpb25zKTtcbiAgICB0aGlzLmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJ1cCcsIHRoaXMucG9pbnRlclVwTGlzdGVuZXIsIGFjdGl2ZUNhcHR1cmluZ0V2ZW50T3B0aW9ucyk7XG5cbiAgICB0aGlzLmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMucG9pbnRlck1vdmVMaXN0ZW5lciwgYWN0aXZlQ2FwdHVyaW5nRXZlbnRPcHRpb25zKTtcbiAgICB0aGlzLmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMucG9pbnRlck1vdmVMaXN0ZW5lciwgYWN0aXZlQ2FwdHVyaW5nRXZlbnRPcHRpb25zKTtcbiAgICB0aGlzLmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJtb3ZlJywgdGhpcy5wb2ludGVyTW92ZUxpc3RlbmVyLCBhY3RpdmVDYXB0dXJpbmdFdmVudE9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIGV4Y2x1ZGVDaGlsZFxuICAgKi9cbiAgcHVibGljIGV4Y2x1ZGVDaGlsZChjb21wb25lbnQ6IFBhblpvb21FeGNsdWRlRGlyZWN0aXZlKTogdm9pZCB7XG4gICAgdGhpcy5leGNsdWRlQ2hpbGRyZW5FbGVtZW50cy5wdXNoKGNvbXBvbmVudCk7XG4gIH1cblxuICAvKipcbiAgICogb25FeGNsdWRlRGVzdHJveWVkXG4gICAqL1xuICBwdWJsaWMgb25FeGNsdWRlRGVzdHJveWVkKGNvbXBvbmVudDogUGFuWm9vbUV4Y2x1ZGVEaXJlY3RpdmUpOiB2b2lkIHtcbiAgICB0aGlzLmV4Y2x1ZGVDaGlsZHJlbkVsZW1lbnRzID0gdGhpcy5leGNsdWRlQ2hpbGRyZW5FbGVtZW50c1xuICAgICAgLmZpbHRlcihjID0+IGMgIT09IGNvbXBvbmVudCk7XG4gIH1cblxuICBwcml2YXRlIHBvaW50ZXJEb3duTGlzdGVuZXIgPSAoZXZlbnQ6IFRvdWNoRXZlbnQgfCBNb3VzZUV2ZW50KSA9PiB7XG4gICAgaWYgKCF0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5leGNsdWRlQ2hpbGRyZW5FbGVtZW50cy5maW5kKGMgPT4gYy5jaGVja0V4Y2x1c2lvbihldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQpKSkge1xuICAgICAgdGhpcy5pc1BvaW50ZXJEb3duID0gZmFsc2U7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuaXNQb2ludGVyRG93biA9IHRydWU7XG4gICAgdGhpcy5wb2ludGVyT3JpZ2luID0gZ2V0Q29vcmRpbmF0ZShldmVudCwgeyB0b3A6IDAsIGxlZnQ6IDAgfSk7XG4gICAgdGhpcy5wcmV2aW91c1ZpZXdCb3ggPSB7IC4uLnRoaXMudmlld0JveCB9O1xuICAgIHRoaXMuYm91bmRpbmdTaXplID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBwb2ludGVyVXBMaXN0ZW5lciA9IChldmVudDogVG91Y2hFdmVudCB8IE1vdXNlRXZlbnQpID0+IHtcbiAgICB0aGlzLmlzUG9pbnRlckRvd24gPSBmYWxzZTtcbiAgICB0aGlzLnByZXZpb3VzVmlld0JveCA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgcG9pbnRlck1vdmVMaXN0ZW5lciA9IChldmVudDogVG91Y2hFdmVudCB8IE1vdXNlRXZlbnQpID0+IHtcbiAgICBpZiAoIXRoaXMuaXNQb2ludGVyRG93bikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuYm91bmRpbmdTaXplKSB7XG4gICAgICB0aGlzLmJvdW5kaW5nU2l6ZSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICB9XG4gICAgLy8gUHJldmVudCB1c2VyIHRvIGRvIGEgc2VsZWN0aW9uIG9uIHRoZSBwYWdlXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgIC8vIEdldCB0aGUgY3VycmVudCBwb2ludGVyIHBvc2l0aW9uXG4gICAgY29uc3QgcG9pbnRlclBvc2l0aW9uID0gZ2V0Q29vcmRpbmF0ZShldmVudCwgeyB0b3A6IDAsIGxlZnQ6IDAgfSk7XG4gICAgY29uc3QgcmF0aW8gPSB0aGlzLnByZXZpb3VzVmlld0JveC53aWR0aCAvIHRoaXMuYm91bmRpbmdTaXplLndpZHRoO1xuXG4gICAgY29uc3QgbmV3Vmlld0JveCA9IHtcbiAgICAgIG1pblg6IHRoaXMucHJldmlvdXNWaWV3Qm94Lm1pblggLSAoKHBvaW50ZXJQb3NpdGlvbi54IC0gdGhpcy5wb2ludGVyT3JpZ2luLngpICogcmF0aW8pLFxuICAgICAgbWluWTogdGhpcy5wcmV2aW91c1ZpZXdCb3gubWluWSAtICgocG9pbnRlclBvc2l0aW9uLnkgLSB0aGlzLnBvaW50ZXJPcmlnaW4ueSkgKiByYXRpbylcbiAgICB9O1xuXG4gICAgdGhpcy52aWV3Qm94Q2hhbmdlZC5lbWl0KHsgLi4udGhpcy52aWV3Qm94LCAuLi5uZXdWaWV3Qm94IH0pO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignd2hlZWwnLCBbJyRldmVudCddKVxuICBvblpvb20oZTogV2hlZWxFdmVudCk6IHZvaWQge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICBjb25zdCBwb3NpdGlvbiA9IGdldENvb3JkaW5hdGUoZSwgdGhpcy5lbC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKTtcbiAgICBjb25zdCBzY2FsZSA9IE1hdGgucG93KHRoaXMuc2NhbGVGYWN0b3IsIGUuZGVsdGFZIDwgMCA/IDEgOiAtMSk7XG4gICAgY29uc3Qgc3ggPSBwb3NpdGlvbi54IC8gdGhpcy5lbC5uYXRpdmVFbGVtZW50LmNsaWVudFdpZHRoO1xuICAgIGNvbnN0IHN5ID0gcG9zaXRpb24ueSAvIHRoaXMuZWwubmF0aXZlRWxlbWVudC5jbGllbnRIZWlnaHQ7XG5cbiAgICBjb25zdCB4ID0gdGhpcy52aWV3Qm94Lm1pblggKyB0aGlzLnZpZXdCb3gud2lkdGggKiBzeDtcbiAgICBjb25zdCB5ID0gdGhpcy52aWV3Qm94Lm1pblkgKyB0aGlzLnZpZXdCb3guaGVpZ2h0ICogc3k7XG4gICAgdGhpcy52aWV3Qm94Q2hhbmdlZC5lbWl0KHtcbiAgICAgIG1pblg6IHggKyBzY2FsZSAqICh0aGlzLnZpZXdCb3gubWluWCAtIHgpLFxuICAgICAgbWluWTogeSArIHNjYWxlICogKHRoaXMudmlld0JveC5taW5ZIC0geSksXG4gICAgICB3aWR0aDogdGhpcy52aWV3Qm94LndpZHRoICogc2NhbGUsXG4gICAgICBoZWlnaHQ6IHRoaXMudmlld0JveC5oZWlnaHQgKiBzY2FsZSxcbiAgICB9KTtcbiAgfVxuXG59XG4iXX0=